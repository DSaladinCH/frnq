# 1) Build stage: install deps & compile
FROM node:lts-alpine AS builder
WORKDIR /app

# install full deps (needed for build)
COPY package.json package-lock.json ./
RUN npm ci

# copy source and build
COPY . .

# prevent dev config from being bundled
RUN rm -f static/config.js

RUN npm run build

# prepare runtime config template
RUN cp static/config.template.js build/client/config.template.js
RUN rm -f build/client/config.js.br build/client/config.js.gz

# 2) Runtime stage: slim down image
FROM node:lts-alpine AS runner
WORKDIR /app

# runtime-only tooling
RUN apk add --no-cache gettext

# Copy only what's needed from builder
COPY --from=builder /app/build ./build
COPY --from=builder /app/static ./static

# entrypoint
COPY frontend/docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

ENV NODE_ENV=production
ENV PORT=3000

EXPOSE 3000

ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["node", "build/index.js"]
